# Builds a release APK and serves it over HTTP for easy download.
# Usage (docker):
#   docker build -f flutter_app/Dockerfile.apk --build-arg APP_URL=https://your-site/ -t socialflow-apk .
#   docker run --rm -p 8080:80 socialflow-apk
#   Then download: http://localhost:8080/app-release.apk

FROM cirrusci/flutter:stable AS build

ARG ANDROID_ORG=com.socialflow.app
ARG APP_URL=https://bc26eb03-4b04-4690-b4c7-fba18b5b1c36-00-1d71ogh8n44b9.sisko.replit.dev/

WORKDIR /src

# Generate a clean Flutter Android project and copy our wrapper code into it.
RUN flutter create --platforms=android --org "${ANDROID_ORG}" app

WORKDIR /src/app

# webview_flutter_android requires min SDK >= 19.
# Patch both older and newer Flutter Android templates.
RUN sed -i -E 's/minSdkVersion[[:space:]]+flutter\\.minSdkVersion/minSdkVersion 19/g; s/minSdkVersion[[:space:]]+16/minSdkVersion 19/g' android/app/build.gradle || true
RUN sed -i -E 's/minSdk[[:space:]]*=[[:space:]]*flutter\\.minSdkVersion/minSdk = 19/g; s/minSdk[[:space:]]*=[[:space:]]*16/minSdk = 19/g' android/app/build.gradle.kts || true
RUN sed -i -E 's/android:minSdkVersion=\"16\"/android:minSdkVersion=\"19\"/g' android/app/src/main/AndroidManifest.xml || true

COPY flutter_app/pubspec.yaml ./pubspec.yaml
COPY flutter_app/analysis_options.yaml ./analysis_options.yaml
COPY flutter_app/lib ./lib

RUN flutter pub get
RUN flutter build apk --release --dart-define=APP_URL="${APP_URL}"

FROM nginx:alpine
COPY --from=build /src/app/build/app/outputs/flutter-apk/app-release.apk /usr/share/nginx/html/app-release.apk
EXPOSE 80
